<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Plasma Hall of Fame</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-emerald-900 via-teal-900 to-green-900 text-white overflow-hidden relative">

<!-- Background Animations -->
<div class="absolute inset-0 overflow-hidden">
    <div class="plasma-bg absolute inset-0"></div>
    <div class="spinning-circle absolute inset-0 flex items-center justify-center">
        <div class="loading-spinner"></div>
    </div>
    <div class="stars absolute inset-0"></div>
</div>

<!-- Audio -->
<audio id="bgMusic" loop preload="auto">
    <source src="./interstellar.mp3" type="audio/mpeg">
</audio>

<!-- Header -->
<header class="relative z-10 text-center py-8">
    <h1 class="text-6xl font-bold bg-gradient-to-r from-emerald-400 via-teal-500 to-green-500 bg-clip-text text-transparent mb-4 animate-pulse">
        âš¡ PLASMA HALL OF FAME âš¡
    </h1>
    <button id="musicToggle" class="bg-gradient-to-r from-emerald-500 to-teal-500 px-6 py-3 rounded-full shadow-lg hover:scale-105 transition-transform">
        ğŸµ Play Music
    </button>
</header>

<!-- Input Section -->
<div class="relative z-10 flex flex-col items-center justify-center px-4">
    <div class="bg-black/30 backdrop-blur-lg rounded-3xl p-8 border border-emerald-500/50 shadow-2xl max-w-md w-full">
        <input type="text" id="usernameInput" placeholder="your_twitter_username" class="w-full pl-3 py-3 mb-4 rounded-xl text-white bg-gray-900/80 focus:outline-none border border-emerald-500/30">
        <button id="submitBtn" class="w-full bg-gradient-to-r from-emerald-500 via-teal-500 to-green-500 py-3 rounded-xl font-bold hover:scale-105 transition-transform">ğŸš€ Join the Wall</button>
        <div id="connectionStatus" class="mt-4 text-center text-yellow-400">ğŸ”„ Checking connection...</div>
    </div>
</div>

<!-- Hall of Fame -->
<div class="relative z-10 px-4 pb-8">
    <!-- Default Users Section -->
    <div class="mb-8">
        <h3 class="text-2xl text-emerald-300 font-bold text-center mb-4">ğŸŒŸ Plasma Legends ğŸŒŸ</h3>
        <div id="defaultUsers" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 max-w-6xl mx-auto mb-6"></div>
    </div>
    
    <!-- Recent Submissions Section -->
    <div class="bg-black/20 backdrop-blur-md rounded-3xl p-6 border border-teal-500/50 max-w-6xl mx-auto">
        <h3 class="text-2xl text-teal-300 font-bold text-center mb-4">âš¡ Recent Submissions âš¡</h3>
        <p id="userCount" class="text-gray-400 text-center mb-4">Loading submissions...</p>
        <div id="hallOfFame" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
    </div>
</div>

<!-- Styles -->
<style>
.plasma-bg {
    background: linear-gradient(45deg, #047857, #0d9488, #059669, #10b981, #34d399);
    background-size: 400% 400%;
    animation: plasmaMove 12s ease-in-out infinite;
    opacity: 0.4;
}

@keyframes plasmaMove {
    0%,100% { background-position:0% 50%; }
    25% { background-position:100% 100%; }
    50% { background-position:100% 0%; }
    75% { background-position:0% 100%; }
}

.loading-spinner {
    width: 300px;
    height: 300px;
    position: relative;
}

.loading-spinner::before {
    content: '';
    position: absolute;
    inset: 0;
    background: conic-gradient(
        from 0deg,
        #ffffff 0deg,
        #ffffff 15deg,
        transparent 15deg,
        transparent 30deg,
        #ffffff 30deg,
        #ffffff 45deg,
        transparent 45deg,
        transparent 60deg,
        #ffffff 60deg,
        #ffffff 75deg,
        transparent 75deg,
        transparent 90deg,
        #ffffff 90deg,
        #ffffff 105deg,
        transparent 105deg,
        transparent 120deg,
        #ffffff 120deg,
        #ffffff 135deg,
        transparent 135deg,
        transparent 150deg,
        #ffffff 150deg,
        #ffffff 165deg,
        transparent 165deg,
        transparent 180deg,
        #ffffff 180deg,
        #ffffff 195deg,
        transparent 195deg,
        transparent 210deg,
        #ffffff 210deg,
        #ffffff 225deg,
        transparent 225deg,
        transparent 240deg,
        #ffffff 240deg,
        #ffffff 255deg,
        transparent 255deg,
        transparent 270deg,
        #ffffff 270deg,
        #ffffff 285deg,
        transparent 285deg,
        transparent 300deg,
        #ffffff 300deg,
        #ffffff 315deg,
        transparent 315deg,
        transparent 330deg,
        #ffffff 330deg,
        #ffffff 345deg,
        transparent 345deg,
        transparent 360deg
    );
    border-radius: 50%;
    animation: spinLoader 4s linear infinite;
    opacity: 0.8;
}

.loading-spinner::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 120px;
    height: 120px;
    background: #064e3b;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    z-index: 1;
}

@keyframes spinLoader {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.stars {
    background-image: 
        radial-gradient(2px 2px at 20px 30px, #34d399, transparent),
        radial-gradient(2px 2px at 40px 70px, rgba(52, 211, 153, 0.8), transparent),
        radial-gradient(1px 1px at 90px 40px, #10b981, transparent);
    background-repeat: repeat;
    background-size: 200px 100px;
    animation: sparkle 20s linear infinite;
    opacity: 0.3;
}

@keyframes sparkle {
    from { transform: translateX(0); }
    to { transform: translateX(-200px); }
}

.user-card {
    transition: all 0.3s ease;
    animation: slideUp 0.8s ease-out;
}

.user-card:hover { 
    transform: translateY(-8px) scale(1.05); 
    box-shadow: 0 25px 50px rgba(16, 185, 129, 0.4);
}

@keyframes slideUp {
    from { opacity: 0; transform: translateY(40px) scale(0.8); } 
    to { opacity: 1; transform: translateY(0) scale(1); }
}

.pulse-ring {
    animation: pulseRing 2s infinite;
}

@keyframes pulseRing {
    0% { transform: scale(1); opacity: 1; } 
    50% { transform: scale(1.15); opacity: 0.7; } 
    100% { transform: scale(1); opacity: 1; }
}

.glow-effect {
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.6); 
    animation: glow 2s ease-in-out infinite alternate;
}

@keyframes glow {
    from { box-shadow: 0 0 20px rgba(16, 185, 129, 0.6); } 
    to { box-shadow: 0 0 30px rgba(52, 211, 153, 0.8); }
}

.avatar-loading {
    background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
</style>

<!-- Script -->
<script>
// API endpoints
const VPS_DIRECT = 'http://162.250.191.81:4000';
const API_GET = 'https://api.allorigins.win/raw?url=' + encodeURIComponent('http://162.250.191.81:4000');

// DOM elements
const usernameInput = document.getElementById('usernameInput');
const submitBtn = document.getElementById('submitBtn');
const hallOfFame = document.getElementById('hallOfFame');
const defaultUsersElement = document.getElementById('defaultUsers');
const bgMusic = document.getElementById('bgMusic');
const musicToggle = document.getElementById('musicToggle');
const connectionStatus = document.getElementById('connectionStatus');
const userCount = document.getElementById('userCount');

let musicPlaying = false;

// Music toggle
musicToggle.addEventListener('click', async () => {
    try {
        if (musicPlaying) { 
            bgMusic.pause(); 
            musicToggle.innerHTML='ğŸµ Play Music'; 
            musicPlaying=false; 
        }
        else { 
            await bgMusic.play(); 
            musicToggle.innerHTML='ğŸ”‡ Pause Music'; 
            musicPlaying=true; 
        }
    } catch(e){ 
        console.log('Audio error:', e);
    }
});

// Updated default users - including your requested additions
const defaultUsers = [
    'proofofnathan', 'scene999', 'MaxApoz', 'shadowofthefax'
];

// Generate a hash from username for consistent colors
function getUserColor(username) {
    let hash = 0;
    for (let i = 0; i < username.length; i++) {
        const char = username.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32-bit integer
    }
    
    const colors = [
        '#059669', '#0d9488', '#0891b2', '#0284c7', '#7c3aed', 
        '#c026d3', '#e11d48', '#ea580c', '#ca8a04', '#65a30d'
    ];
    
    return colors[Math.abs(hash) % colors.length];
}

// Enhanced avatar system with multiple reliable fallbacks
function createAvatarImage(username, isDefault = false) {
    console.log(`ğŸ”„ Creating avatar for ${username} (${isDefault ? 'Legend' : 'Submission'})`);
    
    const img = document.createElement('img');
    const borderColor = isDefault ? 'border-emerald-400' : 'border-teal-400';
    img.className = `w-16 h-16 rounded-xl mx-auto border-2 ${borderColor} shadow-xl object-cover bg-gray-800 avatar-loading`;
    img.alt = `@${username}`;
    img.loading = 'lazy';
    
    // Enhanced fallback chain with more reliable services
    const userColor = getUserColor(username);
    const fallbacks = [
        // Try multiple X/Twitter endpoints
        `https://unavatar.io/x/${username}?fallback=false`,
        `https://unavatar.io/twitter/${username}?fallback=false`, 
        // GitHub (many Twitter users have same username on GitHub)
        `https://avatars.githubusercontent.com/${username}?size=128`,
        `https://github.com/${username}.png?size=128`,
        // Reliable generated avatars
        `https://api.dicebear.com/7.x/personas/svg?seed=${username}&backgroundColor=${userColor.replace('#', '')}&radius=20`,
        `https://api.dicebear.com/7.x/initials/svg?seed=${username}&backgroundColor=${userColor.replace('#', '')}&fontSize=40`,
        // Final fallback - guaranteed to work
        `https://ui-avatars.com/api/?name=${username.charAt(0).toUpperCase()}&background=${userColor.replace('#', '')}&color=fff&size=128&font-size=0.6&bold=true&rounded=true`
    ];
    
    let currentIndex = 0;
    let loadTimeout;
    
    const tryNextFallback = () => {
        if (currentIndex < fallbacks.length) {
            const currentUrl = fallbacks[currentIndex];
            console.log(`  ğŸ“¡ Trying method ${currentIndex + 1}/${fallbacks.length}: ${currentUrl.split('?')[0]}`);
            
            // Clear any existing timeout
            if (loadTimeout) clearTimeout(loadTimeout);
            
            // Set a timeout for each attempt (3 seconds)
            loadTimeout = setTimeout(() => {
                console.log(`  â° Timeout for ${username} method ${currentIndex + 1}`);
                currentIndex++;
                tryNextFallback();
            }, 3000);
            
            img.src = currentUrl;
            currentIndex++;
        } else {
            console.log(`  âŒ All methods failed for ${username}`);
        }
    };
    
    img.onload = () => {
        if (loadTimeout) clearTimeout(loadTimeout);
        img.classList.remove('avatar-loading');
        console.log(`  âœ… Avatar loaded for ${username} using method ${currentIndex}`);
    };
    
    img.onerror = (e) => {
        if (loadTimeout) clearTimeout(loadTimeout);
        console.log(`  âŒ Method ${currentIndex} failed for ${username}:`, e);
        tryNextFallback();
    };
    
    // Start the fallback chain
    tryNextFallback();
    
    return img;
}

// Check VPS connection
async function checkConnection(){
    try {
        console.log('ğŸ”— Checking server connection...');
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const res = await fetch(`${API_GET}/`, {
            method: 'GET',
            signal: controller.signal,
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        clearTimeout(timeoutId);
        
        if(res.ok){ 
            const data = await res.json();
            console.log('âœ… Connection successful:', data);
            connectionStatus.innerHTML='<span class="text-green-400">âœ… Connected to Server</span>'; 
            return true;
        } else {
            throw new Error(`Server responded with ${res.status}`);
        }
    } catch(e){ 
        console.error('âŒ Connection failed:', e);
        connectionStatus.innerHTML=`<span class="text-red-400">âŒ Server Offline - Showing Defaults</span>`; 
        return false;
    }
}

// Enhanced card creation with better structure
function createUserCard(username, isDefault = false, animate = true) {
    console.log(`ğŸ¯ Creating card for: ${username} (${isDefault ? 'Legend' : 'Submission'})`);
    
    const card = document.createElement('div');
    const cardClass = isDefault ? 
        'user-card bg-gradient-to-br from-emerald-600/40 to-green-600/40 backdrop-blur-sm rounded-2xl p-4 border-2 border-emerald-500/60 text-center glow-effect' :
        'user-card bg-gradient-to-br from-teal-600/30 to-cyan-600/30 backdrop-blur-sm rounded-2xl p-4 border border-teal-500/40 text-center';
    
    card.className = `${cardClass} ${animate ? 'pulse-ring' : ''}`;
    
    // Create avatar with enhanced fallback system
    const avatarImg = createAvatarImage(username, isDefault);
    
    // Create text elements
    const nameElement = document.createElement('h3');
    nameElement.className = 'font-bold text-white text-sm mt-3';
    nameElement.textContent = `@${username}`;
    
    const labelElement = document.createElement('div');
    const labelText = isDefault ? 'Plasma Legend' : 'Digital Warrior';
    const labelColor = isDefault ? 'text-emerald-300' : 'text-teal-300';
    labelElement.className = `text-xs ${labelColor} mt-1`;
    labelElement.textContent = labelText;
    
    // Assemble card
    card.appendChild(avatarImg);
    card.appendChild(nameElement);
    card.appendChild(labelElement);
    
    return card;
}

// Show default users (Legends)
function showDefaultUsers() {
    console.log('ğŸŒŸ Loading Plasma Legends...');
    defaultUsersElement.innerHTML = '';
    
    defaultUsers.forEach((username, i) => {
        setTimeout(() => {
            console.log(`  ğŸ“¤ Adding Legend ${i + 1}/${defaultUsers.length}: ${username}`);
            const card = createUserCard(username, true, true);
            defaultUsersElement.appendChild(card);
        }, i * 200); // Staggered animation
    });
}

// Load users from server with session fallback
async function loadUsers(){
    console.log('ğŸ“¡ Loading server submissions...');
    userCount.textContent = 'Loading submissions...';
    
    let serverUsers = [];
    let serverConnected = false;
    
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 8000);
        
        const res = await fetch(`${API_GET}/users`, {
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if(res.ok){
            serverUsers = await res.json();
            serverConnected = true;
            console.log('âœ… Server users loaded:', serverUsers);
        } else {
            throw new Error(`Failed to load users: ${res.status}`);
        }
    } catch(e){ 
        console.error('âŒ Failed to load server users:', e);
        console.log('ğŸ’» Using session storage as fallback...');
    }
    
    // Load session users if server failed
    let sessionUsers = [];
    if (!serverConnected) {
        sessionUsers = JSON.parse(sessionStorage.getItem('plasmaUsers') || '[]');
        console.log('ğŸ’¾ Session users loaded:', sessionUsers);
    }
    
    // Combine server and session users, removing duplicates
    const allUsers = [...new Set([...serverUsers, ...sessionUsers])];
    
    if(allUsers.length === 0) { 
        userCount.textContent = 'No submissions yet - Be the first!';
        return; 
    }
    
    // Clear and show all users
    hallOfFame.innerHTML = '';
    allUsers.forEach((username, i) => {
        setTimeout(() => {
            console.log(`  ğŸ“¤ Adding user ${i + 1}/${allUsers.length}: ${username} (${serverUsers.includes(username) ? 'server' : 'session'})`);
            const card = createUserCard(username, false, true);
            hallOfFame.appendChild(card);
        }, i * 100);
    });
    
    const statusText = serverConnected ? 
        `${allUsers.length} digital warriors and growing!` :
        `${allUsers.length} digital warriors (offline mode)`;
    
    userCount.textContent = statusText;
}

// Save user to server with better error handling
async function saveUser(username){
    console.log('ğŸ’¾ Attempting to save user to server:', username);
    
    // First, try to save to server
    let serverSaveSuccess = false;
    
    try {
        // Try direct VPS connection first
        console.log('ğŸ“¡ Trying direct VPS connection...');
        const directRes = await fetch(`${VPS_DIRECT}/users`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify({ username: username })
        });
        
        if (directRes.ok) {
            const result = await directRes.json();
            console.log('âœ… User saved via direct connection:', result);
            serverSaveSuccess = true;
        } else {
            throw new Error(`Direct connection failed: ${directRes.status}`);
        }
    } catch(directError) {
        console.log('âš ï¸ Direct connection failed:', directError.message);
        
        // Try with CORS proxy
        try {
            console.log('ğŸ“¡ Trying with CORS proxy...');
            const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(`${VPS_DIRECT}/users`);
            const proxyRes = await fetch(proxyUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username: username })
            });
            
            if (proxyRes.ok) {
                const result = await proxyRes.json();
                console.log('âœ… User saved via proxy:', result);
                serverSaveSuccess = true;
            } else {
                throw new Error(`Proxy connection failed: ${proxyRes.status}`);
            }
        } catch(proxyError) {
            console.error('âŒ Both direct and proxy methods failed:', proxyError);
        }
    }
    
    // Always add user to UI regardless of server save status
    console.log('ğŸ¯ Adding user to UI:', username);
    const card = createUserCard(username, false, true);
    hallOfFame.appendChild(card);
    
    // Update count
    const currentCount = hallOfFame.children.length;
    userCount.textContent = `${currentCount} digital warriors and growing!`;
    
    // Store in browser memory for session persistence
    let sessionUsers = JSON.parse(sessionStorage.getItem('plasmaUsers') || '[]');
    if (!sessionUsers.includes(username)) {
        sessionUsers.push(username);
        sessionStorage.setItem('plasmaUsers', JSON.stringify(sessionUsers));
        console.log('ğŸ’¾ User stored in session:', username);
    }
    
    return serverSaveSuccess;
}

// Enhanced submit handler
submitBtn.addEventListener('click', async () => {
    const username = usernameInput.value.trim().replace('@','').replace(/[^a-zA-Z0-9_]/g, '');
    
    if(!username){ 
        alert('Please enter a valid username'); 
        return;
    }
    
    // Check if user already exists
    const existingCards = [...defaultUsersElement.children, ...hallOfFame.children];
    const exists = existingCards.some(card => {
        const nameEl = card.querySelector('h3');
        return nameEl && nameEl.textContent === `@${username}`;
    });
    
    if (exists) {
        alert('This user is already on the wall!');
        return;
    }
    
    submitBtn.disabled = true; 
    submitBtn.textContent = 'Joining the Plasma...';
    
    console.log('ğŸš€ Processing submission:', username);
    
    try {
        const serverSaved = await saveUser(username);
        usernameInput.value = '';
        
        if (serverSaved) {
            connectionStatus.innerHTML = '<span class="text-green-400">âš¡ Saved to Server - Welcome to the Plasma Wall!</span>';
        } else {
            connectionStatus.innerHTML = '<span class="text-yellow-400">âš¡ Added Locally - Will sync when server is back!</span>';
        }
        
        setTimeout(() => {
            connectionStatus.innerHTML = connectionStatus.innerHTML.includes('Connected') ? 
                '<span class="text-green-400">âœ… Connected to Server</span>' : 
                '<span class="text-red-400">âŒ Server Offline - Showing Defaults</span>';
        }, 4000);
        
    } catch (e) {
        console.error('âŒ Submit error:', e);
        connectionStatus.innerHTML = '<span class="text-red-400">âŒ Failed to Add User</span>';
    }
    
    submitBtn.disabled = false; 
    submitBtn.textContent = 'ğŸš€ Join the Wall';
});

// Enter key support
usernameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !submitBtn.disabled) {
        submitBtn.click();
    }
});

// Initialize application
async function init(){
    console.log('ğŸš€ Initializing Plasma Hall of Fame v2.0...');
    console.log('ğŸ‘¥ Default users (Legends):', defaultUsers);
    
    // Show legends immediately
    console.log('ğŸ“‹ Displaying Plasma Legends...');
    showDefaultUsers();
    
    // Check server connection
    const connected = await checkConnection();
    
    // Load server users if connected
    if (connected) {
        console.log('ğŸŒ Server online - loading submissions...');
        await loadUsers();
    } else {
        console.log('ğŸ’» Offline mode - server submissions unavailable');
        userCount.textContent = 'Server offline - Submit to join when back online!';
    }
    
    // Set audio volume
    bgMusic.volume = 0.3;
    
    console.log('âœ¨ Plasma Hall of Fame ready!');
    console.log('ğŸ¯ Users can now submit their Twitter usernames');
    console.log('ğŸ”§ Check console for avatar loading details');
}

// Start the application
init();
</script>

</body>
</html>
