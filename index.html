<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plasma Hall of Fame</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-emerald-900 via-teal-900 to-green-900 text-white overflow-hidden relative">
  <!-- Background Animations -->
  <div class="absolute inset-0 overflow-hidden">
    <div class="plasma-bg absolute inset-0"></div>
    <div class="spinning-circle absolute inset-0 flex items-center justify-center">
      <div class="loading-spinner"></div>
    </div>
    <div class="stars absolute inset-0"></div>
  </div>

  <!-- Audio -->
  <audio id="bgMusic" loop preload="auto">
    <source src="./interstellar.mp3" type="audio/mpeg" />
  </audio>

  <!-- Header -->
  <header class="relative z-10 text-center py-8">
    <div class="flex items-center justify-center gap-4 mb-4">
      <!-- Plasma Logo SVG -->
      <div class="spinning-logo">
        <svg width="60" height="60" viewBox="0 0 100 100" class="text-emerald-400">
          <defs>
            <mask id="segments">
              <rect width="100" height="100" fill="black" />
              <g fill="white">
                <path d="M50,10 A40,40 0 0,1 85.36,35 L75.36,42.5 A27.5,27.5 0 0,0 50,22.5 Z" />
                <path d="M85.36,35 A40,40 0 0,1 85.36,65 L75.36,57.5 A27.5,27.5 0 0,0 75.36,42.5 Z" />
                <path d="M85.36,65 A40,40 0 0,1 50,90 L50,77.5 A27.5,27.5 0 0,0 75.36,57.5 Z" />
                <path d="M50,90 A40,40 0 0,1 14.64,65 L24.64,57.5 A27.5,27.5 0 0,0 50,77.5 Z" />
                <path d="M14.64,65 A40,40 0 0,1 14.64,35 L24.64,42.5 A27.5,27.5 0 0,0 24.64,57.5 Z" />
                <path d="M14.64,35 A40,40 0 0,1 50,10 L50,22.5 A27.5,27.5 0 0,0 24.64,42.5 Z" />
              </g>
            </mask>
          </defs>
          <circle cx="50" cy="50" r="40" fill="currentColor" mask="url(#segments)" />
          <circle cx="50" cy="50" r="15" fill="#064e3b" />
        </svg>
      </div>
      <h1 class="text-6xl font-bold bg-gradient-to-r from-emerald-400 via-teal-500 to-green-500 bg-clip-text text-transparent animate-pulse">
        PLASMA HALL OF FAME
      </h1>
    </div>
    <p class="text-2xl text-teal-300 mb-4">ðŸš€ Trillions ðŸš€</p>
    <button id="musicToggle" class="bg-gradient-to-r from-emerald-500 to-teal-500 px-6 py-3 rounded-full shadow-lg hover:scale-105 transition-transform">
      ðŸŽµ Play Music
    </button>
  </header>

  <!-- Input Section -->
  <div class="relative z-10 flex flex-col items-center justify-center px-4 mb-8">
    <div class="bg-black/30 backdrop-blur-lg rounded-3xl p-8 border border-emerald-500/50 shadow-2xl max-w-md w-full">
      <input
        type="text"
        id="usernameInput"
        placeholder="your_twitter_username"
        class="w-full pl-3 py-3 mb-4 rounded-xl text-white bg-gray-900/80 focus:outline-none border border-emerald-500/30"
      />
      <button
        id="submitBtn"
        class="w-full bg-gradient-to-r from-emerald-500 via-teal-500 to-green-500 py-3 rounded-xl font-bold hover:scale-105 transition-transform"
      >
        ðŸš€ Join the Wall
      </button>
      <div id="connectionStatus" class="mt-4 text-center text-yellow-400">Ready to join the legends</div>
    </div>
  </div>

  <!-- Hall of Fame -->
  <div class="relative z-10 px-4 pb-8">
    <!-- Plasma Legends Section - Always Visible -->
    <div class="mb-8">
      <h3 class="text-3xl text-emerald-300 font-bold text-center mb-6">ðŸ‘‘ PLASMA LEGENDS ðŸ‘‘</h3>
      <div id="defaultUsers" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6 max-w-6xl mx-auto mb-6"></div>
      <p class="text-center text-emerald-400 text-sm">âš¡ The Original Plasma Pioneers âš¡</p>
    </div>

    <!-- Recent Submissions Section -->
    <div class="bg-black/20 backdrop-blur-md rounded-3xl p-6 border border-teal-500/50 max-w-6xl mx-auto">
      <h3 class="text-2xl text-teal-300 font-bold text-center mb-4">âš¡ Recent Submissions âš¡</h3>
      <p id="userCount" class="text-gray-400 text-center mb-4">Loading...</p>
      <div id="hallOfFame" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
    </div>
  </div>

  <!-- Styles -->
  <style>
    .plasma-bg {
      background: linear-gradient(45deg, #047857, #0d9488, #059669, #10b981, #34d399);
      background-size: 400% 400%;
      animation: plasmaMove 12s ease-in-out infinite;
      opacity: 0.4;
    }
    @keyframes plasmaMove {
      0%, 100% { background-position: 0% 50%; }
      25% { background-position: 100% 100%; }
      50% { background-position: 100% 0%; }
      75% { background-position: 0% 100%; }
    }
    .loading-spinner { width: 300px; height: 300px; position: relative; }
    .loading-spinner::before {
      content: '';
      position: absolute; inset: 0;
      background: conic-gradient(
        from 0deg,
        #ffffff 0deg, #ffffff 15deg, transparent 15deg, transparent 30deg,
        #ffffff 30deg, #ffffff 45deg, transparent 45deg, transparent 60deg,
        #ffffff 60deg, #ffffff 75deg, transparent 75deg, transparent 90deg,
        #ffffff 90deg, #ffffff 105deg, transparent 105deg, transparent 120deg,
        #ffffff 120deg, #ffffff 135deg, transparent 135deg, transparent 150deg,
        #ffffff 150deg, #ffffff 165deg, transparent 165deg, transparent 180deg,
        #ffffff 180deg, #ffffff 195deg, transparent 195deg, transparent 210deg,
        #ffffff 210deg, #ffffff 225deg, transparent 225deg, transparent 240deg,
        #ffffff 240deg, #ffffff 255deg, transparent 255deg, transparent 270deg,
        #ffffff 270deg, #ffffff 285deg, transparent 285deg, transparent 300deg,
        #ffffff 300deg, #ffffff 315deg, transparent 315deg, transparent 330deg,
        #ffffff 330deg, #ffffff 345deg, transparent 345deg, transparent 360deg
      );
      border-radius: 50%;
      animation: spinLoader 4s linear infinite;
      opacity: 0.8;
    }
    .loading-spinner::after {
      content: '';
      position: absolute; top: 50%; left: 50%; width: 120px; height: 120px; background: #064e3b; border-radius: 50%; transform: translate(-50%, -50%); z-index: 1;
    }
    @keyframes spinLoader { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .spinning-logo svg { animation: spinLogo 8s linear infinite; }
    @keyframes spinLogo { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .border-3 { border-width: 3px; }

    .stars {
      background-image:
        radial-gradient(2px 2px at 20px 30px, #34d399, transparent),
        radial-gradient(2px 2px at 40px 70px, rgba(52, 211, 153, 0.8), transparent),
        radial-gradient(1px 1px at 90px 40px, #10b981, transparent);
      background-repeat: repeat;
      background-size: 200px 100px;
      animation: sparkle 20s linear infinite;
      opacity: 0.3;
    }
    @keyframes sparkle { from { transform: translateX(0); } to { transform: translateX(-200px); } }

    .user-card { transition: all 0.3s ease; animation: slideUp 0.8s ease-out; }
    .user-card:hover { transform: translateY(-8px) scale(1.05); box-shadow: 0 25px 50px rgba(16, 185, 129, 0.4); }
    @keyframes slideUp { from { opacity: 0; transform: translateY(40px) scale(0.8); } to { opacity: 1; transform: translateY(0) scale(1); } }

    .pulse-ring { animation: pulseRing 2s infinite; }
    @keyframes pulseRing { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.15); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }

    .glow-effect { box-shadow: 0 0 20px rgba(16, 185, 129, 0.6); animation: glow 2s ease-in-out infinite alternate; }
    @keyframes glow { from { box-shadow: 0 0 20px rgba(16, 185, 129, 0.6); } to { box-shadow: 0 0 30px rgba(52, 211, 153, 0.8); } }

    .verified-badge { position: absolute; top: -5px; right: -5px; background: linear-gradient(45deg, #10b981, #34d399); border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 10px; border: 2px solid #064e3b; }
  </style>

  <!-- Script -->
  <script>
    // DOM elements
    const usernameInput = document.getElementById('usernameInput');
    const submitBtn = document.getElementById('submitBtn');
    const hallOfFame = document.getElementById('hallOfFame');
    const defaultUsersElement = document.getElementById('defaultUsers');
    const bgMusic = document.getElementById('bgMusic');
    const musicToggle = document.getElementById('musicToggle');
    const connectionStatus = document.getElementById('connectionStatus');
    const userCount = document.getElementById('userCount');

    let musicPlaying = false;

    // Legends (display-only)
    const defaultUsers = ['proofofnathan', 'scene999', 'maxapoz', 'shadowofthefax'];

    // Music toggle
    musicToggle.addEventListener('click', async () => {
      try {
        if (musicPlaying) {
          bgMusic.pause();
          musicToggle.innerHTML = 'ðŸŽµ Play Music';
          musicPlaying = false;
        } else {
          await bgMusic.play();
          musicToggle.innerHTML = 'ðŸ”‡ Pause Music';
          musicPlaying = true;
        }
      } catch (e) {
        console.log('Audio error:', e);
      }
    });

    // Create avatar (now via backend proxy with graceful fallback)
    function createAvatarImage(username, isLegend = false) {
      const img = document.createElement('img');
      const borderColor = isLegend ? 'border-emerald-400' : 'border-teal-400';
      img.className = `w-20 h-20 rounded-xl mx-auto border-3 ${borderColor} shadow-2xl object-cover bg-gray-800`;
      img.alt = `@${username}`;
      img.loading = 'lazy';

      // Primary source: backend proxy (avoids CORS/Twitter blocks)
      img.src = `/api/avatar?username=${encodeURIComponent(username)}`;

      // Fallback: generated avatar if proxy fails
      img.onerror = () => {
        img.src = `https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(username)}&size=160&fontSize=50`;
      };

      return img;
    }

    // Create user card
    function createUserCard(username, isLegend = false, animate = true) {
      const card = document.createElement('div');
      if (isLegend) {
        card.className = `user-card bg-gradient-to-br from-emerald-500/50 to-green-500/50 backdrop-blur-sm rounded-3xl p-6 border-3 border-emerald-400/80 text-center glow-effect relative overflow-hidden ${animate ? 'pulse-ring' : ''}`;
        const crown = document.createElement('div');
        crown.className = 'absolute top-2 right-2 text-yellow-400 text-xl';
        crown.innerHTML = 'ðŸ‘‘';
        card.appendChild(crown);
      } else {
        card.className = `user-card bg-gradient-to-br from-teal-600/30 to-cyan-600/30 backdrop-blur-sm rounded-2xl p-4 border border-teal-500/40 text-center ${animate ? 'pulse-ring' : ''}`;
        const badge = document.createElement('div');
        badge.className = 'verified-badge';
        badge.innerHTML = 'âœ“';
        card.appendChild(badge);
      }

      const avatarImg = createAvatarImage(username, isLegend);

      const nameElement = document.createElement('h3');
      nameElement.className = isLegend ? 'font-bold text-white text-lg mt-4' : 'font-bold text-white text-sm mt-3';
      nameElement.textContent = `@${username}`;

      const labelElement = document.createElement('div');
      if (isLegend) {
        labelElement.className = 'text-sm text-emerald-200 mt-2 font-semibold';
        labelElement.textContent = 'âš¡ PLASMA LEGEND âš¡';
      } else {
        labelElement.className = 'text-xs text-teal-300 mt-1';
        labelElement.textContent = 'Verified Member';
      }

      card.appendChild(avatarImg);
      card.appendChild(nameElement);
      card.appendChild(labelElement);
      return card;
    }

    // Show Legends
    function showDefaultUsers() {
      defaultUsersElement.innerHTML = '';
      defaultUsers.forEach((username, i) => {
        setTimeout(() => {
          const card = createUserCard(username, true, true);
          defaultUsersElement.appendChild(card);
        }, i * 250);
      });
    }

    // Helpers
    function normalizeUser(u) {
      return u.trim().replace('@', '').replace(/[^a-zA-Z0-9_]/g, '').toLowerCase();
    }

    // Load all users from backend (with localStorage fallback)
    async function loadUsers() {
      hallOfFame.innerHTML = '';
      userCount.textContent = 'Loading...';

      try {
        const res = await fetch('/api/users');
        if (!res.ok) throw new Error('Failed to load users');
        const data = await res.json();
        const users = Array.isArray(data) ? data : (data.users || []);

        if (!users.length) {
          userCount.textContent = 'No submissions yet - Be the first!';
          return;
        }

        users.forEach((username, i) => {
          setTimeout(() => {
            hallOfFame.appendChild(createUserCard(username, false, true));
          }, i * 120);
        });
        userCount.textContent = `${users.length} warriors have joined!`;
      } catch (e) {
        // Fallback to localStorage when backend is unavailable
        console.warn('Backend unavailable, using localStorage. Error:', e);
        const saved = JSON.parse(localStorage.getItem('phof_users') || '[]');
        if (!saved.length) {
          userCount.textContent = 'No submissions yet - Be the first!';
          return;
        }
        saved.forEach((username) => hallOfFame.appendChild(createUserCard(username, false, false)));
        userCount.textContent = `${saved.length} warriors (local) have joined!`;
      }
    }

    // Add a user via backend (with localStorage fallback)
    async function addUser(usernameRaw) {
      const username = normalizeUser(usernameRaw);
      if (!username) {
        alert('Please enter a valid username');
        return;
      }
      if (defaultUsers.includes(username)) {
        alert('This user is already a Plasma Legend!');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Joining...';

      try {
        const res = await fetch('/api/addUser', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username })
        });
        if (!res.ok) throw new Error('Failed to add user');
        const data = await res.json();

        // Update UI
        hallOfFame.prepend(createUserCard(username, false, true));
        userCount.textContent = `${data.totalUsers ?? 'More'} warriors have joined!`;
        usernameInput.value = '';
        connectionStatus.innerHTML = '<span class="text-green-400">âš¡ Welcome to the Plasma Wall!</span>';
      } catch (e) {
        // Local fallback
        console.warn('Backend add failed, saving local. Error:', e);
        const saved = new Set(JSON.parse(localStorage.getItem('phof_users') || '[]'));
        if (saved.has(username)) {
          alert('User already exists (local).');
        } else {
          saved.add(username);
          localStorage.setItem('phof_users', JSON.stringify(Array.from(saved)));
          hallOfFame.prepend(createUserCard(username, false, true));
          userCount.textContent = `${Array.from(saved).length} warriors (local) have joined!`;
          usernameInput.value = '';
          connectionStatus.innerHTML = '<span class="text-green-400">âš¡ (Local) Welcome to the Plasma Wall!</span>';
        }
      } finally {
        setTimeout(() => {
          connectionStatus.innerHTML = 'Ready to join the legends';
        }, 2000);
        submitBtn.disabled = false;
        submitBtn.textContent = 'ðŸš€ Join the Wall';
      }
    }

    // Events
    submitBtn.addEventListener('click', () => addUser(usernameInput.value));
    usernameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !submitBtn.disabled) addUser(usernameInput.value);
    });

    // Init
    function init() {
      showDefaultUsers();
      bgMusic.volume = 0.3;
      loadUsers();
    }
    init();
  </script>
</body>
</html>
