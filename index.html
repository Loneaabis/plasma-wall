<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Plasma Wall - Join the Matrix</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen text-white overflow-hidden relative" style="background: radial-gradient(ellipse at center, #0a0a1a 0%, #000000 70%), linear-gradient(45deg, #001122, #000511, #001122);">

<!-- Enhanced Cosmic Background -->
<div class="absolute inset-0 overflow-hidden">
    <!-- Animated stars field -->
    <div class="stars absolute inset-0"></div>
    <div class="stars2 absolute inset-0"></div>
    <div class="stars3 absolute inset-0"></div>
    
    <!-- Central cosmic portal -->
    <div class="cosmic-portal absolute inset-0 flex items-center justify-center">
        <div class="portal-ring-1"></div>
        <div class="portal-ring-2"></div>
        <div class="portal-ring-3"></div>
        <div class="portal-core"></div>
    </div>
    
    <!-- Floating cosmic particles -->
    <div class="cosmic-particles absolute inset-0">
        <div class="particle p1"></div>
        <div class="particle p2"></div>
        <div class="particle p3"></div>
        <div class="particle p4"></div>
        <div class="particle p5"></div>
        <div class="particle p6"></div>
        <div class="particle p7"></div>
        <div class="particle p8"></div>
    </div>
    
    <!-- Nebula clouds -->
    <div class="nebula absolute inset-0"></div>
    
    <!-- Scanning grid -->
    <div class="cosmic-grid absolute inset-0"></div>
</div>

<!-- Audio -->
<audio id="bgMusic" loop preload="auto" style="display: none;">
    <source src="./interstellar.mp3" type="audio/mpeg">
    <source src="./interstellar.wav" type="audio/wav">
    <source src="./music.mp3" type="audio/mpeg">
</audio>

<!-- Futuristic Header -->
<header class="relative z-10 text-center py-8">
    <h1 class="text-6xl font-bold text-white mb-2 cosmic-glow animate-cosmic-pulse">
        PLASMA NEXUS
    </h1>
    <p class="text-xl text-cyan-300 font-medium interstellar-text">
        Connect to the Cosmic Neural Network
    </p>
    <div class="mt-3 text-sm text-blue-400 pulse-fade" id="liveCounter">
        Scanning quantum signatures across the universe...
    </div>
</header>

<!-- Enhanced Input Section -->
<div class="relative z-10 flex flex-col items-center justify-center px-4 mb-8">
    <div class="input-cosmic flex items-center gap-4 max-w-5xl w-full">
        <div class="input-wrapper flex-1 relative">
            <input 
                type="text" 
                id="usernameInput" 
                placeholder="Enter cosmic handle..." 
                class="w-full px-8 py-5 rounded-2xl text-white bg-black/40 border-2 border-cyan-500/50 focus:outline-none focus:border-cyan-300 focus:ring-2 focus:ring-cyan-300/30 text-lg backdrop-blur-xl cosmic-input transition-all duration-300"
            >
            <div class="input-aurora absolute inset-0 rounded-2xl opacity-0 transition-opacity duration-300"></div>
        </div>
        <button 
            id="submitBtn" 
            class="px-10 py-5 bg-gradient-to-r from-cyan-600 via-blue-600 to-purple-600 hover:from-cyan-500 hover:via-blue-500 hover:to-purple-500 rounded-2xl font-bold text-lg cosmic-button transform hover:scale-105 transition-all duration-300 shadow-2xl"
        >
            <span class="relative z-10">TRANSMIT</span>
        </button>
    </div>
    
    <div class="flex gap-4 mt-6">
        <button 
            id="musicToggle" 
            class="px-8 py-3 bg-gradient-to-r from-indigo-800 to-purple-700 hover:from-indigo-700 hover:to-purple-600 rounded-xl font-medium transition-all duration-300 cosmic-button-small"
        >
            üéµ Activate Cosmic Audio
        </button>
        <button 
            id="syncBtn" 
            class="px-8 py-3 bg-gradient-to-r from-blue-800 to-cyan-700 hover:from-blue-700 hover:to-cyan-600 rounded-xl font-medium transition-all duration-300 cosmic-button-small"
        >
            üîÑ Sync Network
        </button>
        <button 
            id="searchBtn" 
            class="px-8 py-3 bg-gradient-to-r from-purple-800 to-pink-700 hover:from-purple-700 hover:to-pink-600 rounded-xl font-medium transition-all duration-300 cosmic-button-small"
        >
            üîç Search User
        </button>
    </div>
    
    <div id="connectionStatus" class="mt-4 text-center text-cyan-300 status-text">
        Initializing cosmic connection...
    </div>
</div>

<!-- Enhanced Plasma Wall Container -->
<div class="relative z-10 px-4 pb-8">
    <div class="plasma-container bg-black/30 backdrop-blur-2xl rounded-3xl p-8 border-2 border-cyan-500/20 max-w-8xl mx-auto overflow-hidden shadow-2xl cosmic-container">
        <div id="userCount" class="text-center text-cyan-200 mb-8 text-xl font-semibold cosmic-text">
            Scanning neural patterns across the cosmos...
        </div>
        
        <!-- Enhanced Moving Wall -->
        <div class="plasma-wall-container relative h-[500px] overflow-hidden rounded-3xl border border-cyan-500/10 cosmic-wall-bg">
            <div id="movingWall" class="plasma-wall absolute top-0 left-0 flex items-center gap-8 py-8"></div>
            
            <!-- Wall overlay effects -->
            <div class="wall-overlay absolute inset-0 pointer-events-none">
                <div class="cosmic-scan-line absolute w-full h-2 bg-gradient-to-r from-transparent via-cyan-400 to-transparent opacity-70"></div>
                <div class="energy-waves absolute inset-0"></div>
            </div>
        </div>
        
        <div class="flex justify-between items-center mt-6 text-sm">
            <div class="text-cyan-400 cosmic-signature">
                Cosmic Network: ACTIVE ‚Ä¢ Quantum Entangled
            </div>
            <div class="text-cyan-400">
                Created by: aabis ‚Ä¢ Interstellar Edition
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Interstellar Styles -->
<style>
/* Cosmic Color Palette */
:root {
    --cosmic-cyan: #00d4ff;
    --cosmic-blue: #0080ff;
    --cosmic-purple: #8000ff;
    --cosmic-pink: #ff00aa;
    --deep-space: #000511;
    --nebula-blue: #001a33;
}

/* Animated Stars Field */
.stars {
    width: 2px;
    height: 2px;
    background: transparent;
    box-shadow: 
        1780px 1216px #fff, 1819px 1080px #fff, 1408px 506px #fff, 1825px 1503px #fff,
        413px 1652px #fff, 1433px 1910px #fff, 1925px 1270px #fff, 654px 1493px #fff,
        1868px 1892px #fff, 144px 1033px #fff, 1306px 1222px #fff, 1885px 448px #fff,
        1394px 1889px #fff, 366px 931px #fff, 1779px 1292px #fff, 1949px 1674px #fff,
        1039px 766px #fff, 161px 1830px #fff, 1410px 1736px #fff, 1280px 15px #fff,
        1076px 1732px #fff, 1529px 1679px #fff, 1412px 1170px #fff, 1180px 1344px #fff,
        392px 1561px #fff, 1346px 1655px #fff, 1056px 1607px #fff, 663px 1496px #fff,
        1353px 1604px #fff, 147px 1838px #fff, 1022px 1110px #fff, 1969px 1050px #fff,
        1437px 1303px #fff, 1699px 474px #fff, 1694px 1463px #fff, 1088px 1593px #fff,
        1034px 1883px #fff, 1474px 1925px #fff, 1688px 1824px #fff, 1688px 1824px #fff;
    animation: animStar 50s linear infinite;
}

.stars2 {
    width: 3px;
    height: 3px;
    background: transparent;
    box-shadow: 
        679px 1240px var(--cosmic-cyan), 1342px 717px var(--cosmic-cyan), 1958px 1674px var(--cosmic-cyan),
        1273px 1762px var(--cosmic-cyan), 1917px 1246px var(--cosmic-cyan), 1235px 1430px var(--cosmic-cyan),
        1732px 1793px var(--cosmic-cyan), 1534px 1079px var(--cosmic-cyan), 974px 1775px var(--cosmic-cyan),
        1717px 1671px var(--cosmic-cyan), 1853px 1232px var(--cosmic-cyan), 262px 1206px var(--cosmic-cyan),
        1739px 1445px var(--cosmic-cyan), 1031px 1176px var(--cosmic-cyan), 1810px 922px var(--cosmic-cyan),
        1988px 1852px var(--cosmic-cyan), 904px 1480px var(--cosmic-cyan), 259px 1067px var(--cosmic-cyan),
        814px 362px var(--cosmic-cyan), 1183px 1574px var(--cosmic-cyan), 1686px 671px var(--cosmic-cyan);
    animation: animStar 100s linear infinite;
}

.stars3 {
    width: 4px;
    height: 4px;
    background: transparent;
    box-shadow: 
        1949px 943px var(--cosmic-blue), 1128px 1467px var(--cosmic-blue), 1881px 1123px var(--cosmic-blue),
        924px 1198px var(--cosmic-blue), 1617px 1590px var(--cosmic-blue), 1720px 428px var(--cosmic-blue),
        1696px 1508px var(--cosmic-blue), 1331px 1293px var(--cosmic-blue), 1045px 1491px var(--cosmic-blue),
        1084px 1034px var(--cosmic-blue), 1597px 1408px var(--cosmic-blue), 1893px 1867px var(--cosmic-blue);
    animation: animStar 150s linear infinite;
}

@keyframes animStar {
    from { transform: translateY(0px); }
    to { transform: translateY(-2000px); }
}

/* Cosmic Portal */
.cosmic-portal {
    pointer-events: none;
}

.portal-ring-1 {
    width: 800px;
    height: 800px;
    position: absolute;
    border: 3px solid transparent;
    border-radius: 50%;
    background: conic-gradient(
        from 0deg,
        transparent 0deg,
        var(--cosmic-cyan) 2deg,
        transparent 5deg,
        transparent 90deg,
        var(--cosmic-blue) 92deg,
        transparent 95deg,
        transparent 270deg,
        var(--cosmic-purple) 272deg,
        transparent 275deg
    );
    animation: portalSpin1 20s linear infinite;
    opacity: 0.6;
    filter: blur(1px);
}

.portal-ring-2 {
    width: 500px;
    height: 500px;
    position: absolute;
    border: 2px solid transparent;
    border-radius: 50%;
    background: conic-gradient(
        from 180deg,
        transparent 0deg,
        var(--cosmic-blue) 10deg,
        transparent 20deg,
        var(--cosmic-purple) 180deg,
        transparent 190deg,
        var(--cosmic-pink) 350deg,
        transparent 360deg
    );
    animation: portalSpin2 15s linear infinite reverse;
    opacity: 0.8;
}

.portal-ring-3 {
    width: 300px;
    height: 300px;
    position: absolute;
    border: 2px solid rgba(0, 212, 255, 0.3);
    border-radius: 50%;
    animation: portalSpin3 10s linear infinite;
    box-shadow: 0 0 50px rgba(0, 212, 255, 0.5);
}

.portal-core {
    width: 100px;
    height: 100px;
    position: absolute;
    background: radial-gradient(circle, var(--cosmic-cyan), var(--cosmic-blue), transparent);
    border-radius: 50%;
    animation: portalPulse 3s ease-in-out infinite;
    filter: blur(2px);
}

@keyframes portalSpin1 { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes portalSpin2 { from { transform: rotate(360deg); } to { transform: rotate(0deg); } }
@keyframes portalSpin3 { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes portalPulse {
    0%, 100% { transform: scale(1); opacity: 0.8; }
    50% { transform: scale(1.5); opacity: 1; }
}

/* Cosmic Particles */
.cosmic-particles {
    pointer-events: none;
}

.particle {
    position: absolute;
    background: radial-gradient(circle, var(--cosmic-cyan), transparent);
    border-radius: 50%;
    animation: particleDrift 20s ease-in-out infinite;
}

.p1 { width: 4px; height: 4px; top: 10%; left: 10%; animation-delay: 0s; }
.p2 { width: 6px; height: 6px; top: 20%; right: 15%; animation-delay: -2s; }
.p3 { width: 3px; height: 3px; bottom: 30%; left: 25%; animation-delay: -4s; }
.p4 { width: 5px; height: 5px; top: 70%; right: 20%; animation-delay: -6s; }
.p5 { width: 4px; height: 4px; bottom: 20%; right: 30%; animation-delay: -8s; }
.p6 { width: 7px; height: 7px; top: 50%; left: 5%; animation-delay: -10s; }
.p7 { width: 3px; height: 3px; top: 30%; left: 70%; animation-delay: -12s; }
.p8 { width: 5px; height: 5px; bottom: 40%; left: 80%; animation-delay: -14s; }

@keyframes particleDrift {
    0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.7; }
    25% { transform: translate(50px, -100px) scale(1.5); opacity: 1; }
    50% { transform: translate(-30px, -200px) scale(0.8); opacity: 0.5; }
    75% { transform: translate(-80px, 50px) scale(1.2); opacity: 0.9; }
}

/* Nebula Effect */
.nebula {
    background: 
        radial-gradient(ellipse at 20% 30%, rgba(0, 212, 255, 0.1) 0%, transparent 70%),
        radial-gradient(ellipse at 80% 70%, rgba(128, 0, 255, 0.08) 0%, transparent 70%),
        radial-gradient(ellipse at 50% 50%, rgba(0, 128, 255, 0.06) 0%, transparent 80%),
        radial-gradient(ellipse at 30% 80%, rgba(255, 0, 170, 0.05) 0%, transparent 60%);
    animation: nebulaFlow 30s ease-in-out infinite;
}

@keyframes nebulaFlow {
    0%, 100% { opacity: 0.6; transform: scale(1) rotate(0deg); }
    50% { opacity: 1; transform: scale(1.1) rotate(2deg); }
}

/* Cosmic Grid */
.cosmic-grid {
    background-image: 
        linear-gradient(rgba(0, 212, 255, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 212, 255, 0.05) 1px, transparent 1px);
    background-size: 100px 100px;
    animation: gridDrift 40s linear infinite;
    opacity: 0.3;
}

@keyframes gridDrift {
    0% { transform: translate(0, 0); }
    100% { transform: translate(100px, 100px); }
}

/* Enhanced Typography */
.cosmic-glow {
    text-shadow: 
        0 0 10px var(--cosmic-cyan),
        0 0 20px var(--cosmic-cyan),
        0 0 30px var(--cosmic-blue),
        0 0 40px var(--cosmic-blue);
}

@keyframes cosmic-pulse {
    0%, 100% { 
        text-shadow: 
            0 0 10px var(--cosmic-cyan),
            0 0 20px var(--cosmic-cyan),
            0 0 30px var(--cosmic-blue);
    }
    50% { 
        text-shadow: 
            0 0 20px var(--cosmic-cyan),
            0 0 30px var(--cosmic-cyan),
            0 0 40px var(--cosmic-blue),
            0 0 50px var(--cosmic-purple);
    }
}

.animate-cosmic-pulse {
    animation: cosmic-pulse 3s ease-in-out infinite;
}

.interstellar-text {
    font-family: 'Courier New', monospace;
    text-shadow: 0 0 10px var(--cosmic-cyan);
    letter-spacing: 2px;
}

/* Enhanced Input Styling */
.cosmic-input {
    background: linear-gradient(135deg, rgba(0, 5, 17, 0.8), rgba(0, 26, 51, 0.6));
    box-shadow: 
        inset 0 0 30px rgba(0, 212, 255, 0.1),
        0 0 30px rgba(0, 212, 255, 0.1);
    font-family: 'Courier New', monospace;
    letter-spacing: 1px;
}

.cosmic-input:focus + .input-aurora {
    opacity: 1;
    background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(128, 0, 255, 0.1));
}

.cosmic-button {
    background: linear-gradient(135deg, var(--cosmic-cyan), var(--cosmic-blue), var(--cosmic-purple));
    box-shadow: 
        0 0 30px rgba(0, 212, 255, 0.4),
        inset 0 0 30px rgba(255, 255, 255, 0.1);
    text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
    position: relative;
    overflow: hidden;
}

.cosmic-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: cosmicShine 4s ease-in-out infinite;
}

@keyframes cosmicShine {
    0% { left: -100%; }
    100% { left: 100%; }
}

/* Enhanced Wall Container */
.cosmic-container {
    animation: containerMaterialize 2s ease-out;
    box-shadow: 
        0 0 80px rgba(0, 212, 255, 0.15),
        inset 0 0 50px rgba(0, 212, 255, 0.05);
}

@keyframes containerMaterialize {
    from { transform: translateY(100px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.cosmic-wall-bg {
    background: 
        linear-gradient(135deg, rgba(0, 5, 17, 0.4), rgba(0, 212, 255, 0.02)),
        radial-gradient(ellipse at center, rgba(0, 212, 255, 0.05) 0%, transparent 70%);
}

/* Enhanced Plasma Wall */
.plasma-wall {
    width: max-content;
    animation: cosmicFlow 80s linear infinite;
    padding: 30px 0;
}

@keyframes cosmicFlow {
    from { transform: translateX(0); }
    to { transform: translateX(-50%); }
}

/* Cosmic Scan Line */
.cosmic-scan-line {
    animation: cosmicScan 4s ease-in-out infinite;
    background: linear-gradient(90deg, 
        transparent, 
        var(--cosmic-cyan), 
        var(--cosmic-blue), 
        var(--cosmic-cyan), 
        transparent
    );
}

@keyframes cosmicScan {
    0%, 100% { top: 0; opacity: 0.7; }
    50% { top: 95%; opacity: 0.3; }
}

/* Energy Waves */
.energy-waves::before,
.energy-waves::after {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--cosmic-blue), transparent);
    animation: waveFlow 6s ease-in-out infinite;
}

.energy-waves::before {
    top: 25%;
    animation-delay: 0s;
}

.energy-waves::after {
    top: 75%;
    animation-delay: -3s;
}

@keyframes waveFlow {
    0%, 100% { opacity: 0; transform: scaleX(0); }
    50% { opacity: 1; transform: scaleX(1); }
}

/* Enhanced Avatar Cards */
.avatar-card {
    flex-shrink: 0;
    width: 160px;
    height: 160px;
    position: relative;
    transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    animation: cardBeam 1s ease-out;
    filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.4));
}

@keyframes cardBeam {
    from { 
        transform: scale(0.1) translateY(-200px); 
        opacity: 0;
        filter: blur(20px);
    }
    to { 
        transform: scale(1) translateY(0); 
        opacity: 1;
        filter: blur(0px);
    }
}

.avatar-card:hover {
    transform: scale(1.2) translateY(-20px);
    z-index: 20;
    filter: drop-shadow(0 0 40px rgba(0, 212, 255, 0.8));
}

.avatar-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 25px;
    border: 3px solid var(--cosmic-cyan);
    box-shadow: 
        0 0 40px rgba(0, 212, 255, 0.5),
        inset 0 0 30px rgba(0, 212, 255, 0.1);
    transition: all 0.5s ease;
    background: linear-gradient(135deg, var(--cosmic-blue), var(--cosmic-purple));
}

.avatar-card:hover .avatar-img {
    border-color: var(--cosmic-purple);
    box-shadow: 
        0 0 60px rgba(128, 0, 255, 0.8),
        inset 0 0 40px rgba(128, 0, 255, 0.2);
    filter: brightness(1.3) saturate(1.2);
}

.handle-display {
    position: absolute;
    bottom: -15px;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, rgba(0, 5, 17, 0.95), rgba(0, 212, 255, 0.15));
    color: var(--cosmic-cyan);
    text-align: center;
    padding: 10px 6px;
    font-size: 14px;
    font-weight: bold;
    font-family: 'Courier New', monospace;
    border-radius: 0 0 25px 25px;
    border: 3px solid var(--cosmic-cyan);
    border-top: none;
    backdrop-filter: blur(15px);
    transition: all 0.4s ease;
    text-shadow: 0 0 8px rgba(0, 212, 255, 0.8);
    letter-spacing: 1px;
}

.avatar-card:hover .handle-display {
    background: linear-gradient(135deg, rgba(0, 212, 255, 0.9), rgba(128, 0, 255, 0.8));
    color: var(--deep-space);
    text-shadow: 0 0 8px rgba(0, 0, 0, 0.8);
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 212, 255, 0.6);
}

/* Enhanced Loading States */
.loading-cosmic {
    background: linear-gradient(
        45deg, 
        rgba(0, 5, 17, 0.9) 25%, 
        rgba(0, 212, 255, 0.3) 50%, 
        rgba(128, 0, 255, 0.2) 75%,
        rgba(0, 5, 17, 0.9) 100%
    );
    background-size: 400% 400%;
    animation: cosmicShimmer 3s ease-in-out infinite;
    border-radius: 25px;
    border: 3px solid var(--cosmic-cyan);
    position: relative;
    overflow: hidden;
}

.loading-cosmic::before {
    content: '‚ú¶';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 40px;
    color: var(--cosmic-cyan);
    animation: cosmicSpin 2s linear infinite;
    text-shadow: 0 0 20px var(--cosmic-cyan);
}

@keyframes cosmicShimmer {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

@keyframes cosmicSpin {
    from { transform: translate(-50%, -50%) rotate(0deg); }
    to { transform: translate(-50%, -50%) rotate(360deg); }
}

.error-cosmic {
    background: linear-gradient(135deg, var(--cosmic-cyan), var(--cosmic-blue), var(--cosmic-purple));
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--deep-space);
    font-size: 36px;
    font-weight: bold;
    border-radius: 25px;
    border: 3px solid var(--cosmic-cyan);
    animation: errorBeacon 3s ease-in-out infinite;
    text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
}

@keyframes errorBeacon {
    0%, 100% { box-shadow: 0 0 40px rgba(0, 212, 255, 0.5); }
    50% { box-shadow: 0 0 80px rgba(0, 212, 255, 1); }
}

/* Status and Counter Styling */
.status-text, .cosmic-text, .cosmic-signature {
    font-family: 'Courier New', monospace;
    text-shadow: 0 0 10px var(--cosmic-cyan);
    letter-spacing: 1px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .input-cosmic {
        flex-direction: column;
        gap: 20px;
    }
    
    .avatar-card {
        width: 140px;
        height: 140px;
    }
    
    .portal-ring-1 { width: 500px; height: 500px; }
    .portal-ring-2 { width: 350px; height: 350px; }
    .portal-ring-3 { width: 200px; height: 200px; }
}
</style>

<!-- Enhanced JavaScript -->
<script>
// Enhanced Configuration
const CONFIG = {
    SERVER_URL: 'http://162.250.191.81:4000',
    PROXY_URLS: [
        'https://api.allorigins.win/raw?url=',
        'https://cors-anywhere.herokuapp.com/',
        'https://thingproxy.freeboard.io/fetch/'
    ],
    TIMEOUT: 5000,
    MAX_RETRIES: 2,
    RETRY_DELAY: 1500,
    AVATAR_TIMEOUT: 2000
};

const STORAGE_KEY = 'cosmic_wall_users';
const LAST_SYNC_KEY = 'cosmic_wall_last_sync';

// DOM elements
const usernameInput = document.getElementById('usernameInput');
const submitBtn = document.getElementById('submitBtn');
const syncBtn = document.getElementById('syncBtn');
const searchBtn = document.getElementById('searchBtn');
const movingWall = document.getElementById('movingWall');
const bgMusic = document.getElementById('bgMusic');
const musicToggle = document.getElementById('musicToggle');
const connectionStatus = document.getElementById('connectionStatus');
const userCount = document.getElementById('userCount');
const liveCounter = document.getElementById('liveCounter');

let musicPlaying = false;
let syncInProgress = false;

// Enhanced default users with better mix
const DEFAULT_USERS = [
    'proofofnathan', 'scene999', 'MaxApoz', 'shadowofthefax',
    'primay_eth', 'kolyposts', 'Buja_Ques', 'CATTtwit', 
    'The9bo', 'cryptobaikan', 'ImFaziiii', 'pauliepunt', 
    'happysubstack', '0xlinkevm', 'lucidxpl', 'cblison',
    'elonmusk', 'naval', 'balajis', 'vitalikbuterin'
];

let allUsers = [...DEFAULT_USERS];
let searchedUsers = [];

// Enhanced localStorage functions
function saveUsersToStorage() {
    try {
        const userData = {
            users: allUsers.filter(user => !DEFAULT_USERS.includes(user)),
            searched: searchedUsers,
            timestamp: Date.now(),
            version: '3.0'
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(userData));
        localStorage.setItem(LAST_SYNC_KEY, Date.now().toString());
        console.log('üåå Cosmic data saved:', userData.users.length + userData.searched.length, 'consciousness signatures');
        return true;
    } catch (e) {
        console.error('‚ùå Cosmic storage failed:', e);
        return false;
    }
}

function loadUsersFromStorage() {
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const userData = JSON.parse(saved);
            const savedUsers = userData.users || [];
            searchedUsers = userData.searched || [];
            console.log('üì¶ Cosmic data loaded:', savedUsers.length + searchedUsers.length, 'signatures');
            allUsers = [...new Set([...DEFAULT_USERS, ...savedUsers, ...searchedUsers])];
            return savedUsers;
        }
    } catch (e) {
        console.error('‚ùå Cosmic load failed:', e);
    }
    return [];
}

// Enhanced music functionality
musicToggle.addEventListener('click', async () => {
    try {
        if (musicPlaying) { 
            bgMusic.pause(); 
            musicToggle.textContent = 'üéµ Activate Cosmic Audio'; 
            musicPlaying = false; 
            console.log('üîá Cosmic audio deactivated');
        } else { 
            bgMusic.volume = 0.4;
            await bgMusic.play(); 
            musicToggle.textContent = 'üîá Deactivate Cosmic Audio'; 
            musicPlaying = true; 
            console.log('üéµ Cosmic audio activated');
        }
    } catch(e) { 
        console.error('‚ùå Cosmic audio error:', e);
        updateStatus('‚ö†Ô∏è Cosmic audio offline - check audio files', 'warning');
    }
});

// Force sync functionality
syncBtn.addEventListener('click', async () => {
    if (syncInProgress) return;
    
    syncInProgress = true;
    syncBtn.disabled = true;
    syncBtn.textContent = 'üîÑ Syncing...';
    
    updateStatus('üîÑ Synchronizing with cosmic network...', 'info');
    
    const success = await loadFromBackend(true);
    
    setTimeout(() => {
        syncBtn.disabled = false;
        syncBtn.textContent = 'üîÑ Sync Network';
        syncInProgress = false;
        
        if (success) {
            updateStatus('‚úÖ Cosmic sync complete - network updated', 'success');
        } else {
            updateStatus('‚ö†Ô∏è Sync incomplete - operating in local mode', 'warning');
        }
    }, 2000);
});

// Enhanced user search functionality
searchBtn.addEventListener('click', async () => {
    const username = usernameInput.value.trim().replace('@', '').replace(/[^a-zA-Z0-9_]/g, '');
    
    if (!username || username.length < 2) {
        alert('‚ö†Ô∏è Enter a valid username to search');
        return;
    }
    
    if (allUsers.includes(username)) {
        alert('üåü User already exists in the cosmic network!');
        return;
    }
    
    searchBtn.disabled = true;
    searchBtn.textContent = 'üîç Searching...';
    updateStatus('üîç Scanning cosmic web for user existence...', 'info');
    
    try {
        // Check if user exists by trying to load their profile
        const userExists = await checkUserExists(username);
        
        if (userExists) {
            // Add to searched users list and update wall
            searchedUsers.push(username);
            allUsers.push(username);
            saveUsersToStorage();
            displayPlasmaWall();
            updateStatus(`‚úÖ User @${username} found and added to cosmic network!`, 'success');
            usernameInput.value = '';
        } else {
            updateStatus(`‚ùå User @${username} not found in the cosmic web`, 'error');
        }
    } catch (error) {
        console.error('Search error:', error);
        updateStatus('‚ö†Ô∏è Search failed - cosmic interference detected', 'warning');
    }
    
    setTimeout(() => {
        searchBtn.disabled = false;
        searchBtn.textContent = 'üîç Search User';
    }, 2000);
});

// Check if user exists by attempting to load their avatar
async function checkUserExists(username) {
    console.log(`üîç Searching cosmic web for: ${username}`);
    
    // High-priority sources for user existence check
    const checkSources = [
        `https://unavatar.io/twitter/${username}?fallback=false`,
        `https://unavatar.io/x/${username}?fallback=false`,
        `https://github.com/${username}.png?size=40`,
        `https://unavatar.io/${username}?fallback=false`
    ];
    
    for (const source of checkSources) {
        try {
            const response = await fetch(source, { 
                method: 'HEAD',
                signal: AbortSignal.timeout(3000)
            });
            
            if (response.ok && response.headers.get('content-type')?.startsWith('image/')) {
                console.log(`‚úÖ User ${username} found via ${source.includes('twitter') || source.includes('/x/') ? 'X/Twitter' : source.includes('github') ? 'GitHub' : 'Web'}`);
                return true;
            }
        } catch (error) {
            console.log(`‚ùå Check failed for ${username} on ${source.split('/')[2]}`);
        }
    }
    
    return false;
}

// Enhanced status update function
function updateStatus(message, type = 'info') {
    connectionStatus.textContent = message;
    connectionStatus.className = `mt-4 text-center status-text ${
        type === 'success' ? 'text-cyan-300' :
        type === 'warning' ? 'text-yellow-400' :
        type === 'error' ? 'text-red-400' :
        'text-cyan-300'
    }`;
    
    setTimeout(() => {
        if (connectionStatus.textContent === message) {
            connectionStatus.textContent = 'Cosmic network ready for transmission';
            connectionStatus.className = 'mt-4 text-center status-text text-cyan-300';
        }
    }, 5000);
}

// Ultra-enhanced avatar loading system optimized for speed
function createAvatarCard(username) {
    console.log(`üñºÔ∏è Materializing cosmic avatar for: ${username}`);
    
    const card = document.createElement('div');
    card.className = 'avatar-card';
    
    const img = document.createElement('img');
    img.className = 'avatar-img loading-cosmic';
    img.alt = username;
    
    const overlay = document.createElement('div');
    overlay.className = 'handle-display';
    overlay.textContent = `@${username}`;
    
    card.appendChild(img);
    card.appendChild(overlay);
    
    // Optimized avatar sources - prioritizing fast-loading and reliable sources
    const avatarSources = [
        // HIGHEST PRIORITY: Fast and reliable sources
        `https://unavatar.io/twitter/${username}?fallback=false`,
        `https://unavatar.io/x/${username}?fallback=false`,
        `https://github.com/${username}.png?size=160`,
        
        // HIGH PRIORITY: Good fallbacks
        `https://unavatar.io/${username}?fallback=false`,
        `https://unavatar.io/instagram/${username}?fallback=false`,
        
        // GENERATED AVATARS: Fast loading, always work
        `https://api.dicebear.com/7.x/personas/svg?seed=${username}&size=160&backgroundColor=00d4ff,0080ff,8000ff&randomizeIds=true`,
        `https://api.dicebear.com/7.x/avataaars/svg?seed=${username}&size=160&backgroundColor=00d4ff,0080ff,8000ff&randomizeIds=true`,
        `https://api.dicebear.com/7.x/bottts/svg?seed=${username}&size=160&backgroundColor=00d4ff,0080ff,8000ff&randomizeIds=true`,
        
        // COSMIC THEMED: Robot and abstract
        `https://robohash.org/${username}?size=160x160&set=set1&bgset=bg2&hues=cyan`,
        `https://source.boringavatars.com/beam/160/${username}?colors=00d4ff,0080ff,8000ff,ff00aa,001a33`,
        
        // LETTER AVATARS: Always reliable
        `https://ui-avatars.com/api/?name=${username.charAt(0).toUpperCase()}&background=00d4ff&color=000511&size=160&bold=true&rounded=true&font-size=0.6`
    ];
    
    let sourceIndex = 0;
    let loadStartTime = Date.now();
    
    const tryLoadAvatar = () => {
        if (sourceIndex >= avatarSources.length) {
            console.log(`‚ùå All sources failed for ${username}, creating cosmic fallback`);
            createFallbackAvatar();
            return;
        }
        
        const currentSource = avatarSources[sourceIndex];
        const sourceType = getSourceType(currentSource);
        
        console.log(`  üì° Cosmic scan ${sourceIndex + 1}/${avatarSources.length} for ${username}: ${sourceType}`);
        
        // Faster timeout for better UX
        const timeout = setTimeout(() => {
            console.log(`  ‚è∞ Timeout for ${username}`);
            sourceIndex++;
            tryLoadAvatar();
        }, CONFIG.AVATAR_TIMEOUT);
        
        const onSuccess = () => {
            clearTimeout(timeout);
            const loadTime = Date.now() - loadStartTime;
            img.classList.remove('loading-cosmic');
            console.log(`  ‚úÖ AVATAR LOADED: ${username} via ${sourceType} (${loadTime}ms)`);
            
            // Cosmic success animation
            card.style.animation = 'cardBeam 0.8s ease-out';
        };
        
        const onError = () => {
            clearTimeout(timeout);
            console.log(`  ‚ùå Failed: ${sourceType} for ${username}`);
            sourceIndex++;
            tryLoadAvatar();
        };
        
        img.onload = () => {
            if (img.naturalWidth > 5 && img.naturalHeight > 5) {
                onSuccess();
            } else {
                onError();
            }
        };
        
        img.onerror = onError;
        img.src = currentSource;
    };
    
    const createFallbackAvatar = () => {
        card.removeChild(img);
        const fallbackDiv = document.createElement('div');
        fallbackDiv.className = 'error-cosmic';
        fallbackDiv.style.width = '100%';
        fallbackDiv.style.height = '100%';
        fallbackDiv.textContent = username.charAt(0).toUpperCase();
        card.insertBefore(fallbackDiv, overlay);
    };
    
    const getSourceType = (source) => {
        if (source.includes('twitter') || source.includes('/x/')) return 'X/Twitter';
        if (source.includes('github')) return 'GitHub';
        if (source.includes('dicebear')) return 'Generated';
        if (source.includes('robohash')) return 'Robot';
        if (source.includes('boring')) return 'Abstract';
        if (source.includes('ui-avatars')) return 'Letter';
        return 'Web';
    };
    
    tryLoadAvatar();
    return card;
}

// Enhanced display function with cosmic animations
function displayPlasmaWall() {
    console.log('üåå Materializing cosmic wall with', allUsers.length, 'consciousness entities');
    
    movingWall.innerHTML = '';
    
    // Create cards with staggered cosmic timing
    allUsers.forEach((username, index) => {
        setTimeout(() => {
            const card = createAvatarCard(username);
            card.style.animationDelay = `${index * 0.05}s`;
            movingWall.appendChild(card);
        }, index * 50);
    });
    
    // Duplicate for seamless loop
    setTimeout(() => {
        allUsers.forEach((username, index) => {
            setTimeout(() => {
                const card = createAvatarCard(username);
                card.style.animationDelay = `${(allUsers.length + index) * 0.05}s`;
                movingWall.appendChild(card);
            }, index * 40);
        });
    }, allUsers.length * 50 + 500);
    
    // Update cosmic counters
    userCount.textContent = `${allUsers.length} Cosmic Entities Connected`;
    liveCounter.textContent = `Cosmic Network: ${allUsers.length} consciousness signatures detected across space-time`;
}

// Enhanced backend communication
async function saveToBackend(username) {
    console.log('üöÄ Initiating cosmic transmission for:', username);
    
    for (let retry = 0; retry < CONFIG.MAX_RETRIES; retry++) {
        try {
            const response = await fetch(`${CONFIG.SERVER_URL}/users`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
                body: JSON.stringify({ username }),
                signal: AbortSignal.timeout(CONFIG.TIMEOUT)
            });
            
            if (response.ok) {
                console.log('‚úÖ Cosmic transmission successful');
                return true;
            }
        } catch (error) {
            console.log(`‚ùå Transmission attempt ${retry + 1} failed:`, error.message);
            if (retry < CONFIG.MAX_RETRIES - 1) {
                await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY));
            }
        }
    }
    
    return false;
}

async function loadFromBackend(forceSync = false) {
    console.log('üì° Scanning cosmic network...', forceSync ? '(FORCED)' : '');
    
    try {
        const response = await fetch(`${CONFIG.SERVER_URL}/users`, {
            method: 'GET',
            headers: { 'Cache-Control': forceSync ? 'no-cache' : 'max-age=300' },
            signal: AbortSignal.timeout(CONFIG.TIMEOUT)
        });
        
        if (response.ok) {
            const serverUsers = await response.json();
            console.log('‚úÖ Cosmic network data received:', serverUsers.length, 'entities');
            
            const localUsers = loadUsersFromStorage();
            const allServerUsers = Array.isArray(serverUsers) ? serverUsers : [];
            allUsers = [...new Set([...DEFAULT_USERS, ...allServerUsers, ...localUsers, ...searchedUsers])];
            
            updateStatus('‚úÖ Cosmic network synchronized', 'success');
            return true;
        }
    } catch (error) {
        console.log('‚ùå Cosmic network scan failed:', error.message);
    }
    
    loadUsersFromStorage();
    updateStatus('‚ö†Ô∏è Operating in local mode - cosmic network offline', 'warning');
    return false;
}

// Enhanced user submission
async function submitUser(username) {
    const cleanUsername = username.replace('@', '').replace(/[^a-zA-Z0-9_]/g, '');
    
    if (!cleanUsername || cleanUsername.length < 2) {
        alert('‚ö†Ô∏è Cosmic signature invalid - minimum 2 characters required');
        return;
    }
    
    if (cleanUsername.length > 30) {
        alert('‚ö†Ô∏è Cosmic signature too long - maximum 30 characters');
        return;
    }
    
    if (allUsers.includes(cleanUsername)) {
        alert('‚ö° Consciousness already exists in the cosmic matrix!');
        return;
    }
    
    console.log('üß¨ Processing cosmic transmission:', cleanUsername);
    
    // Enhanced submit animation
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="relative z-10">‚ú¶ TRANSMITTING...</span>';
    submitBtn.style.transform = 'scale(0.95)';
    updateStatus('üß¨ Transmitting consciousness to cosmic network...', 'info');
    
    // Immediate local transmission
    allUsers.push(cleanUsername);
    const saved = saveUsersToStorage();
    
    if (!saved) {
        allUsers.pop();
        updateStatus('‚ùå Local storage failure - transmission aborted', 'error');
        resetSubmitButton();
        return;
    }
    
    displayPlasmaWall();
    
    // Background cosmic sync
    const backendSaved = await saveToBackend(cleanUsername);
    
    if (backendSaved) {
        updateStatus('‚úÖ Consciousness successfully transmitted and synchronized!', 'success');
    } else {
        updateStatus('‚úÖ Consciousness transmitted locally - will sync when cosmic network returns', 'warning');
    }
    
    // Clear input with cosmic animation
    usernameInput.style.transform = 'scale(0.95)';
    setTimeout(() => {
        usernameInput.value = '';
        usernameInput.style.transform = 'scale(1)';
    }, 200);
    
    setTimeout(resetSubmitButton, 3000);
    console.log('‚ú® Cosmic transmission complete - consciousness integrated');
}

function resetSubmitButton() {
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<span class="relative z-10">TRANSMIT</span>';
    submitBtn.style.transform = 'scale(1)';
}

// Event listeners
submitBtn.addEventListener('click', () => {
    const username = usernameInput.value.trim();
    if (username && !submitBtn.disabled) {
        submitUser(username);
    }
});

usernameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !submitBtn.disabled) {
        const username = usernameInput.value.trim();
        if (username) {
            // Check if Shift is held to search instead of submit
            if (e.shiftKey) {
                searchBtn.click();
            } else {
                submitUser(username);
            }
        }
    }
});

// Enhanced input effects
usernameInput.addEventListener('focus', () => {
    usernameInput.nextElementSibling.style.opacity = '1';
});

usernameInput.addEventListener('blur', () => {
    usernameInput.nextElementSibling.style.opacity = '0';
});

// Real-time cosmic counter updates
setInterval(() => {
    const timestamp = new Date().toLocaleTimeString();
    liveCounter.textContent = `Cosmic Network: ${allUsers.length} active signatures [${timestamp}] ‚Ä¢ Spanning infinite dimensions`;
}, 20000);

// Enhanced initialization
async function initializeCosmicMatrix() {
    console.log('üåå INITIALIZING COSMIC PLASMA NEXUS...');
    console.log('üéµ Cosmic audio files: ./interstellar.mp3, ./interstellar.wav, ./music.mp3');
    console.log('üë• Default cosmic signatures:', DEFAULT_USERS.length);
    console.log('üíæ Quantum storage protocol: ACTIVE');
    console.log('üîç User search system: ENABLED');
    console.log('üîÑ Enhanced avatar matrix: OPTIMIZED');
    
    updateStatus('üåå Cosmic nexus initialization in progress...', 'info');
    
    // Initialize cosmic network
    const networkOnline = await loadFromBackend();
    
    // Display the plasma wall
    displayPlasmaWall();
    
    console.log('‚ú® COSMIC PLASMA NEXUS ONLINE');
    console.log(`üß¨ Total consciousness signatures: ${allUsers.length}`);
    console.log(`üì° Network status: ${networkOnline ? 'ONLINE' : 'OFFLINE'}`);
    console.log('üîç User search: Press Shift+Enter to search instead of add');
    
    setTimeout(() => {
        if (connectionStatus.textContent.includes('initialization')) {
            updateStatus('‚ö° Cosmic nexus ready for consciousness transmission', 'success');
        }
    }, 2000);
}

// Auto-sync with performance optimization
setInterval(async () => {
    if (!syncInProgress && document.visibilityState === 'visible') {
        console.log('üîÑ Auto-sync initiated...');
        await loadFromBackend();
        displayPlasmaWall();
    }
}, 300000);

// Visibility change optimization
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
        console.log('üëÅÔ∏è Tab visible - cosmic nexus active');
    } else {
        console.log('üåô Tab hidden - cosmic nexus standby mode');
    }
});

// Initialize the enhanced cosmic matrix
initializeCosmicMatrix();
