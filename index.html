<script>
const API_BASE = 'http://162.250.191.81:4000';

const usernameInput = document.getElementById('usernameInput');
const submitBtn = document.getElementById('submitBtn');
const hallOfFame = document.getElementById('hallOfFame');
const bgMusic = document.getElementById('bgMusic');
const musicToggle = document.getElementById('musicToggle');
const connectionStatus = document.getElementById('connectionStatus');
const userCount = document.getElementById('userCount');

let musicPlaying = false;

musicToggle.addEventListener('click', async () => {
    try {
        if (musicPlaying) {
            bgMusic.pause();
            musicToggle.innerHTML = 'üéµ Play Interstellar Music';
            musicToggle.classList.remove('glow-effect');
            musicPlaying = false;
        } else {
            await bgMusic.play();
            musicToggle.innerHTML = 'üîá Pause Music';
            musicToggle.classList.add('glow-effect');
            musicPlaying = true;
        }
    } catch (error) {
        musicToggle.innerHTML = '‚ùå Music Unavailable';
    }
});

async function checkConnection() {
    try {
        const response = await fetch(`${API_BASE}/`);
        if (response.ok) {
            connectionStatus.innerHTML = '<span class="text-green-400">‚úÖ Connected to VPS server</span>';
            return true;
        } else throw new Error('Server error');
    } catch {
        connectionStatus.innerHTML = '<span class="text-red-400">‚ùå Server offline</span>';
        return false;
    }
}

async function saveUser(username) {
    try {
        const cleanUsername = username.replace('@','').trim();
        const response = await fetch(`${API_BASE}/users`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: cleanUsername })
        });

        if (response.ok) {
            await loadUsers();
            return { success: true };
        } else {
            const err = await response.json();
            return { success: false, error: err.error || 'Unknown error' };
        }
    } catch (error) {
        return { success: false, error: error.message };
    }
}

async function loadUsers() {
    try {
        const res = await fetch(`${API_BASE}/users`);
        if (!res.ok) throw new Error('Failed to load users');
        const users = await res.json();
        hallOfFame.innerHTML = '';
        if (users.length === 0) {
            showEmptyState();
            userCount.textContent = 'No legends yet';
        } else {
            users.forEach(u => addUserCard(u, true));
            userCount.textContent = `${users.length} digital legends`;
        }
    } catch {
        showOfflineDemo();
    }
}

function addUserCard(username, animate = true) {
    const card = document.createElement('div');
    card.className = `user-card bg-gradient-to-br from-purple-600/30 to-pink-600/30 backdrop-blur-sm rounded-2xl p-4 border border-purple-500/40 text-center hover:border-purple-400/70 ${animate?'pulse-ring':''}`;
    card.innerHTML = `
        <div class="relative mb-3">
            <img src="https://unavatar.io/twitter/${username}" alt="@${username}" class="w-16 h-16 rounded-full mx-auto border-3 border-purple-400 shadow-xl hover:border-pink-400 transition-colors duration-300" onerror="this.src='https://via.placeholder.com/64'"/>
            <div class="absolute -bottom-1 -right-1 w-7 h-7 bg-gradient-to-r from-green-400 to-blue-500 rounded-full border-2 border-white flex items-center justify-center animate-bounce" style="animation-duration: 2s;">
                <span class="text-sm">‚ö°</span>
            </div>
        </div>
        <h3 class="font-bold text-white truncate text-sm hover:text-purple-300 transition-colors duration-300">@${username}</h3>
    `;
    hallOfFame.appendChild(card);
}

function showEmptyState() {
    hallOfFame.innerHTML = `<div class="col-span-full text-center py-12"><div class="bg-purple-500/20 backdrop-blur-sm rounded-3xl p-8 border border-purple-500/30 glow-effect"><h3 class="text-3xl font-bold text-purple-400 mb-3">Be the First Legend!</h3><p class="text-gray-300 text-lg">Enter your Twitter username above to claim your spot!</p></div></div>`;
}

function showOfflineDemo() {
    hallOfFame.innerHTML = `<div class="col-span-full text-center py-8"><div class="bg-red-500/20 backdrop-blur-sm rounded-2xl p-6 border border-red-500/30 mb-6"><h3 class="text-xl font-bold text-red-400 mb-2">‚ö†Ô∏è Server Connection Failed</h3><p class="text-gray-300">Demo mode - submissions won't be saved</p></div></div>`;
    const demoUsers = ['elonmusk', 'jack', 'sundarpichai'];
    demoUsers.forEach(u => addUserCard(u, false));
    userCount.textContent = `${demoUsers.length} demo legends`;
}

submitBtn.addEventListener('click', async () => {
    const username = usernameInput.value.trim();
    if(!username){ alert('Enter username!'); return; }
    submitBtn.textContent = 'üöÄ Joining...';
    submitBtn.disabled = true;
    const result = await saveUser(username);
    if(result.success){
        usernameInput.value = '';
        submitBtn.textContent = '‚úÖ Joined!';
    } else{
        submitBtn.textContent = '‚ùå Failed';
        alert(result.error);
    }
    setTimeout(()=>{ submitBtn.textContent = 'üöÄ Join the Wall'; submitBtn.disabled=false; },2000);
});

usernameInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') submitBtn.click(); });

async function init(){
    await checkConnection();
    await loadUsers();
    bgMusic.volume=0.3;
}

init();
</script>
